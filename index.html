<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>‡§ó‡§£‡§™‡§§‡•Ä ‡§Æ‡§Ç‡§°‡§≥ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‚Äî Final</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhai+2:wght@700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:"Noto Sans Devanagari",sans-serif;background:#fffaf3;color:#222}
    header{background:linear-gradient(90deg,#ff7043,#ff9800);color:white;padding:12px 18px;font-weight:800;font-size:20px;display:flex;justify-content:space-between;align-items:center}
    nav{background:#fff3e0;padding:8px;display:flex;gap:8px;border-bottom:1px solid #f0d7b5}
    nav button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;background:transparent}
    nav .active{background:#ff7043;color:white}
    .container{max-width:1100px;margin:16px auto;padding:12px}
    .card{background:#fff;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.06);padding:14px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 220px;min-width:160px}
    label{display:block;font-size:13px;color:#444;margin-bottom:6px}
    input,select,textarea,button{font-size:14px}
    input,select,textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box}
    textarea{min-height:70px}
    button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:#169873;color:white}
    .btn-secondary{background:#999;color:white}
    .small{padding:6px 8px;font-size:13px}
    .list{margin-top:10px}
    .row-item{padding:8px;border:1px solid #eee;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #e8dcc0;padding:8px;text-align:left}
    th{background:#fff3d4}
    .dashboard{display:flex;gap:12px;flex-wrap:wrap}
    .dash-card{background:#fffef8;border:1px solid #f1d9a6;border-radius:8px;padding:10px;min-width:180px}
    .muted{color:#666;font-size:13px}
    .logo-row{display:flex;gap:12px;align-items:center}
    .logo-preview{max-height:80px;border:1px solid #eee;padding:6px;background:white}
    /* New style for report group name */
    .report-group-name {
      color: #ff7043; /* Orange color */
      font-size: 28px; /* Bigger size */
      font-family: 'Baloo Bhai 2', cursive; /* Stylish Marathi font */
      font-weight: 700; /* Bold */
    }
    .report-meta-item {
        display: block;
        margin-top: 4px;
    }
    @media (max-width:720px){ .row{flex-direction:column} .logo-row{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <header>
    <div>‡§ó‡§£‡§™‡§§‡•Ä ‡§Æ‡§Ç‡§°‡§≥ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä</div>
    <div id="headerRight"></div>
  </header>

  <nav id="mainNav" style="display:none">
    <button onclick="navOpen('dashboard')" id="navDashboard">Dashboard</button>
    <button onclick="navOpen('info')" id="navInfo">Info</button>
    <button onclick="navOpen('members')" id="navMembers">Members</button>
    <button onclick="navOpen('committee')" id="navCommittee">Executive Committee</button>
    <button onclick="navOpen('expenses')" id="navExpenses">Expenses</button>
    <button onclick="navOpen('signatures')" id="navSign">Signatures</button>
    <button onclick="navOpen('report')" id="navReport">Report</button>
  </nav>

  <div class="container">

    <section id="secRegister" class="card">
      <h3>üìù ‡§®‡§µ‡•Ä‡§® Group Register ‡§ï‡§∞‡§æ</h3>
      <div class="row">
        <div class="col"><label>Group Name</label><input id="regGroup" placeholder="‡§â‡§¶‡§æ. ‡§ó‡§£‡§™‡§§‡•Ä ‡§Æ‡§Ç‡§°‡§≥"/></div>
        <div class="col"><label>Login ID</label><input id="regId" placeholder="‡§â‡§¶‡§æ. gangapti123"/></div>
        <div class="col"><label>Password</label><input id="regPass" type="password"/></div>
      </div>
      <div style="margin-top:10px">
        <button class="btn-primary" onclick="doRegister()">Register</button>
        <button class="btn-secondary" onclick="showSection('secLogin')">Login</button>
      </div>
      <p id="regMsg" class="muted"></p>
    </section>

    <section id="secLogin" class="card" style="display:none">
      <h3>üîë Login</h3>
      <div class="row">
        <div class="col"><label>Login ID</label><input id="loginId"/></div>
        <div class="col"><label>Password</label><input id="loginPass" type="password"/></div>
      </div>
      <div style="margin-top:10px">
        <button class="btn-primary" onclick="doLogin()">Login</button>
        <button class="btn-secondary" onclick="showSection('secRegister')">Register</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </section>

    <section id="secApp" style="display:none">

      <section id="page-dashboard" class="card">
        <h3>üìä Dashboard ‚Äî Year-wise Records</h3>
        <div style="margin-bottom:10px">
          <button class="btn-primary small" onclick="addYearPrompt()">‚ûï Add New Year</button>
          <button class="btn-secondary small" onclick="exportAll()">Export All (JSON)</button>
          <button class="btn-secondary small" onclick="importPrompt()">Import JSON</button>
        </div>
        <div id="yearsList" class="dashboard"></div>
      </section>

      <section id="page-info" class="card" style="display:none">
        <h3>‡§Æ‡§Ç‡§°‡§≥ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä (Group Info)</h3>
        <div class="row">
          <div class="col"><label>Group Name</label><input id="groupName"/></div>
          <div class="col"><label>Moto / ‡§â‡§¶‡•ç‡§¶‡•á‡§∂ (optional)</label><input id="groupMoto" placeholder="‡§â‡§¶‡§æ. ‡§∏‡•á‡§µ‡§æ ‡§µ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡•Ä"/></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>Group Logo (upload)</label>
            <input id="groupLogoFile" type="file" accept="image/*"/>
          </div>
          <div class="col">
            <label>Ganpati Logo (upload)</label>
            <input id="ganpatiLogoFile" type="file" accept="image/*"/>
          </div>
          <div class="col">
            <label>Year</label>
            <select id="yearSelect"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col"><label>‡§∏‡•ç‡§•‡§æ‡§™‡§®‡•á‡§ö‡§æ ‡§µ‡§∞‡•ç‡§∑</label><select id="estYear"></select></div>
          <div class="col"><label>‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§ö‡•Ä ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï (‚Çπ)</label><input id="prevBalance" type="number"/></div>
          <div class="col"><label>‡§ó‡§£‡§™‡§§‡•Ä ‡§Æ‡•Ç‡§∞‡•ç‡§§‡•Ä ‡§¶‡§æ‡§§‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</label><input id="ganpatiDonorName" placeholder="‡§â‡§¶‡§æ. ‡§∂‡•ç‡§∞‡•Ä. ‡§™‡§æ‡§ü‡•Ä‡§≤"/></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col" style="display:flex;align-items:flex-end;gap:8px">
            <button class="btn-primary" onclick="saveInfo()">Save Info</button>
            <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
          </div>
        </div>

        <div style="margin-top:12px" class="logo-row">
          <div>
            <div class="muted">Preview Group Logo</div>
            <img id="previewGroupLogo" class="logo-preview" src="" alt="" />
          </div>
          <div>
            <div class="muted">Preview Ganpati Logo</div>
            <img id="previewGanpatiLogo" class="logo-preview" src="" alt="" />
          </div>
        </div>
      </section>

      <section id="page-members" class="card" style="display:none">
        <h3>‡§∏‡§¶‡§∏‡•ç‡§Ø (Master list + Year-wise amounts)</h3>
        <div class="row">
          <div class="col"><label>Member Name</label><input id="newMemberName" placeholder="‡§®‡§æ‡§µ"/></div>
          <div class="col"><label>Default Amount (optional)</label><input id="newMemberAmount" type="number" placeholder="‚Çπ"/></div>
          <div class="col" style="display:flex;align-items:flex-end"><button class="btn-primary" onclick="addMasterMember()">Add Member</button></div>
        </div>

        <div style="margin-top:12px">
          <h4>Master Members (for group)</h4>
          <div id="masterMembersList" class="list"></div>
        </div>

        <div style="margin-top:12px">
          <h4>This year's amounts ‚Äî <span id="labelCurrentYear"></span></h4>
          <div id="membersForYear" class="list"></div>
          <div style="margin-top:10px">
            <button class="btn-primary" onclick="saveMembersForYear()">Save This Year's Amounts</button>
            <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
          </div>
        </div>
      </section>

      <section id="page-committee" class="card" style="display:none">
        <h3>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§Æ‡§ø‡§§‡•Ä (Executive Committee)</h3>
        <div class="row">
          <div class="col"><label>Member</label><select id="comMemberSelect"></select></div>
          <div class="col"><label>Role</label><select id="comRoleSelect"><option>‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑</option><option>‡§â‡§™‡§æ‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑</option><option>‡§ñ‡§ú‡§ø‡§®‡§¶‡§æ‡§∞</option><option>‡§∏‡§ö‡§ø‡§µ</option><option>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑</option></select></div>
          <div class="col" style="display:flex;align-items:flex-end"><button class="btn-primary" onclick="addCommitteeMember()">Add to Committee</button></div>
        </div>

        <div style="margin-top:12px">
          <h4>This year's committee</h4>
          <div id="committeeList" class="list"></div>
          <div style="margin-top:10px">
            <button class="btn-primary" onclick="saveCommittee()">Save Committee</button>
            <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
          </div>
        </div>
      </section>

      <section id="page-expenses" class="card" style="display:none">
        <h3>‡§ñ‡§∞‡•ç‡§ö</h3>
        <div class="row">
          <div class="col"><label>Expense Name</label><input id="expenseName" placeholder="‡§â‡§¶‡§æ. ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§ñ‡§∞‡•ç‡§ö"/></div>
          <div class="col"><label>Amount 1</label><input id="expenseAmt1" type="number"/></div>
          <div class="col"><label>Amount 2</label><input id="expenseAmt2" type="number"/></div>
        </div>
        <div style="margin-top:8px"><button class="btn-primary" onclick="addExpense()">Add Expense</button></div>

        <div style="margin-top:12px">
          <h4>This year's expenses</h4>
          <div id="expensesList" class="list"></div>
          <div style="margin-top:10px">
            <button class="btn-primary" onclick="saveExpenses()">Save Expenses</button>
            <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
          </div>
        </div>
      </section>

      <section id="page-signatures" class="card" style="display:none">
        <h3>‡§∏‡•ç‡§µ‡§æ‡§ï‡•ç‡§∑‡§∞‡•Ä ‡§™‡§¶‡•á</h3>
        <div class="row">
          <div class="col"><label>Role</label><input id="signRoleInput" placeholder="‡§â‡§¶‡§æ. ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑"/></div>
          <div class="col" style="display:flex;align-items:flex-end"><button class="btn-primary" onclick="addSignRole()">Add</button></div>
        </div>

        <div style="margin-top:12px">
          <h4>This year's sign roles</h4>
          <div id="signRolesList" class="list"></div>
          <div style="margin-top:10px"><button class="btn-secondary" onclick="navOpen('dashboard')">Back</button></div>
        </div>
      </section>

      <section id="page-report" class="card" style="display:none">
        <div class="row">
          <div class="col">
            <img id="reportGroupLogo" class="logo-preview" src="" alt="Group Logo" />
          </div>
          <div class="col">
            <h2 id="reportTitle"></h2>
            <div id="reportMoto" class="muted"></div>
            <div id="reportMeta" class="muted"></div>
          </div>
          <div class="col">
            <img id="reportGanpatiLogo" class="logo-preview" src="" alt="Ganpati Logo" />
          </div>
        </div>

        <h4 style="margin-top:12px">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§Æ‡§ø‡§§‡•Ä</h4>
        <table id="reportCommittee"><thead><tr><th>‡§®‡§æ‡§µ</th><th>‡§™‡§¶</th></tr></thead><tbody></tbody></table>

        <h4 style="margin-top:12px">‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</h4>
        <table id="reportMembersSummary"><thead><tr><th>‡§µ‡§∞‡•ç‡§£‡§®</th><th>‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</th></tr></thead><tbody></tbody></table>

        <h4 style="margin-top:12px">‡§ñ‡§∞‡•ç‡§ö</h4>
        <table id="reportExpenses"><thead><tr><th>‡§ñ‡§∞‡•ç‡§ö</th><th>‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</th></tr></thead><tbody></tbody></table>

        <h4 style="margin-top:12px">‡§∏‡•ç‡§µ‡§æ‡§ï‡•ç‡§∑‡§±‡•ç‡§Ø‡§æ</h4>
        <div id="reportSignatures"></div>

        <div style="margin-top:12px">
          <button class="btn-primary" onclick="window.print()">Print / Save PDF</button>
          <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
        </div>
      </section>

    </section>
  </div>

<script>
/* Data model stored under localStorage.users keyed by loginId
users = {
  [id]: {
    password: "...",
    groupName: "...",
    masterMembers: ["A","B",...],
    records: {
      "2025": {
         group: { est, prevBalance, moto, groupLogo (base64), ganpatiLogo (base64), ganpatiDonorName }, // Added ganpatiDonorName
         membersAmounts: { "A":100, "B":200, ... },
         committee: [{name,role},...],
         expenses: [{name,a1,a2,total},...],
         signRoles: [...]
      }, ...
    }
  }
}
*/

let users = JSON.parse(localStorage.getItem("users") || "{}");
let currentUser = null;
let currentYear = new Date().getFullYear().toString();

// helper
const $ = id => document.getElementById(id);

function showSection(sec){
  // show top-level pages: register/login/app
  // Ensure all are hidden first, then display the requested one.
  ['secRegister','secLogin','secApp'].forEach(s=>{
    $(s).style.display = 'none'; // Hide all
  });
  $(sec).style.display = 'block'; // Show the requested one
}

// navigation within app pages
function navOpen(page){
  // ensure app visible
  $('secApp').style.display = 'block';
  // hide all pages
  ['page-dashboard','page-info','page-members','page-committee','page-expenses','page-signatures','page-report'].forEach(p=>$(p).style.display='none');
  // show selected
  $(`page-${page}`).style.display = 'block';
  // highlight nav
  document.querySelectorAll('#mainNav button').forEach(b=>b.classList.remove('active'));
  document.querySelector(`#nav${capitalize(page)}`)?.classList.add('active');
  // specific renders
  if(page==='dashboard') renderYearsList();
  if(page==='info') renderInfo();
  if(page==='members') renderMasterAndYearMembers();
  if(page==='committee') renderCommittee();
  if(page==='expenses') renderExpensesList();
  if(page==='signatures') renderSignRolesList();
  if(page==='report') renderReport();
}
function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

/* ========== Auth & initial UI ========== */
function doRegister(){
  const g = $('regGroup').value.trim();
  const id = $('regId').value.trim();
  const pass = $('regPass').value;
  if(!g || !id || !pass){ $('regMsg').textContent = '‡§∏‡§∞‡•ç‡§µ ‡§´‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡§æ'; return; }
  users = JSON.parse(localStorage.getItem('users')||'{}');
  if(users[id]){ $('regMsg').textContent = '‡§π‡§æ ID ‡§Ü‡§ß‡•Ä‡§ö ‡§Ü‡§π‡•á'; return; }
  users[id] = { password: pass, groupName: g, masterMembers: [], records: {} };
  localStorage.setItem('users', JSON.stringify(users));
  $('regMsg').textContent = 'Registered. Now login.';
  $('regGroup').value=''; $('regId').value=''; $('regPass').value='';
  showSection('secLogin');
}
function doLogin(){
  const id = $('loginId').value.trim();
  const pass = $('loginPass').value;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  if(users[id] && users[id].password === pass){
    currentUser = id;
    // show app nav
    $('mainNav').style.display = 'flex';
    $('headerRight').innerHTML = `<strong>${users[id].groupName || id}</strong> &nbsp; <button class="btn-secondary small" onclick="doLogout()">Logout</button>`;
    // ensure yearSelect populated
    populateYearSelect();
    // set default currentYear if not existing
    if(!users[currentUser].records) users[currentUser].records = {};
    if(!users[currentUser].records[currentYear]) {
      // create default record for currentYear ensuring master members blank keys
      users[currentUser].records[currentYear] = { group:{}, membersAmounts:{}, committee:[], expenses:[], signRoles:[] };
      localStorage.setItem('users', JSON.stringify(users));
    }
    showSection('secApp');
    navOpen('dashboard');
    $('loginId').value=''; $('loginPass').value='';
  } else {
    $('loginMsg').textContent = 'Login failed ‚Äî ID ‡§ï‡§ø‡§Ç‡§µ‡§æ Password ‡§§‡§™‡§æ‡§∏‡§æ';
  }
}
function doLogout(){
  currentUser = null;
  $('mainNav').style.display = 'none';
  $('headerRight').innerHTML = '';
  showSection('secLogin');
}

/* ========== Year selection helpers ========== */
function populateYearSelect(){
  const sel = $('yearSelect');
  sel.innerHTML = '';
  const cur = new Date().getFullYear();
  for(let y=1950;y<=2050;y++){
    const opt = document.createElement('option'); opt.value = String(y); opt.textContent = String(y);
    if(String(y)===currentYear) opt.selected = true;
    sel.appendChild(opt);
  }
  // estYear
  const ey = $('estYear'); ey.innerHTML = '';
  for(let y=1950;y<=2050;y++){ const o=document.createElement('option');o.value=String(y);o.textContent=String(y); ey.appendChild(o); }
  sel.onchange = function(){ currentYear = sel.value; // on change load/create record
    if(currentUser) loadYear(currentYear);
    renderMasterAndYearMembers();
  }
}

/* ========== Year records management ========= */
function addYearPrompt(){
  if(!currentUser) return alert('‡§ï‡•É‡§™‡§Ø‡§æ login ‡§ï‡§∞‡§æ');
  let y = prompt('‡§®‡§µ‡•Ä‡§® ‡§µ‡§∞‡•ç‡§∑ ‡§ü‡§æ‡§ï‡§æ (‡§â‡§¶‡§æ. 2025)');
  if(!y) return;
  y = String(y);
  users = JSON.parse(localStorage.getItem('users')||'{}');
  if(!users[currentUser]) return alert('user missing');
  if(users[currentUser].records && users[currentUser].records[y]) return alert('‡§π‡•Ä ‡§µ‡§∞‡•ç‡§∑ ‡§Ü‡§ß‡•Ä‡§ö ‡§Ü‡§π‡•á');
  // create new year record; ensure master members keys exist (copy empty or previous)
  users[currentUser].records = users[currentUser].records || {};
  // try to copy previous year's member list amounts if present, else blank
  const prevYear = Object.keys(users[currentUser].records).sort().reverse()[0]; // latest existing
  const newRec = { group: {}, membersAmounts: {}, committee: [], expenses: [], signRoles: [] };
  // ensure masterMembers exist
  users[currentUser].masterMembers = users[currentUser].masterMembers || [];
  users[currentUser].masterMembers.forEach(m=>{
    if(prevYear && users[currentUser].records[prevYear] && users[currentUser].records[prevYear].membersAmounts && (m in users[currentUser].records[prevYear].membersAmounts)){
      // do not carry amount automatically ‚Äî keep empty string so user fills new amount
      newRec.membersAmounts[m] = "";
    } else {
      newRec.membersAmounts[m] = "";
    }
  });
  users[currentUser].records[y] = newRec;
  localStorage.setItem('users', JSON.stringify(users));
  loadYear(y);
  renderYearsList();
  navOpen('members');
}

function loadYear(y){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  currentYear = String(y);
  // ensure record exists
  if(!users[currentUser].records) users[currentUser].records = {};
  if(!users[currentUser].records[currentYear]) {
    users[currentUser].records[currentYear] = { group:{}, membersAmounts:{}, committee:[], expenses:[], signRoles:[] };
  }
  // ensure keys for master members exist
  users[currentUser].masterMembers = users[currentUser].masterMembers || [];
  users[currentUser].masterMembers.forEach(m => {
    if(!(m in users[currentUser].records[currentYear].membersAmounts)) users[currentUser].records[currentYear].membersAmounts[m] = "";
  });
  localStorage.setItem('users', JSON.stringify(users));
  // update UI selects and fields
  populateYearSelect();
  $('yearSelect').value = currentYear;
  renderMasterAndYearMembers();
  renderCommittee();
  renderExpensesList();
  renderSignRolesList();
  renderInfo();
  renderYearsList();
}

/* ========== Info save (logos, moto) ========== */
function renderInfo(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  $('groupName').value = u.groupName || '';
  const rec = u.records && u.records[currentYear] ? u.records[currentYear] : null;
  if(rec && rec.group){
    $('groupMoto').value = rec.group.moto || '';
    $('estYear').value = rec.group.est || '';
    $('prevBalance').value = rec.group.prevBalance || '';
    $('ganpatiDonorName').value = rec.group.ganpatiDonorName || ''; // Load donor name
    if(rec.group.groupLogo) $('previewGroupLogo').src = rec.group.groupLogo;
    else $('previewGroupLogo').src = '';
    if(rec.group.ganpatiLogo) $('previewGanpatiLogo').src = rec.group.ganpatiLogo;
    else $('previewGanpatiLogo').src = '';
  } else {
    $('groupMoto').value=''; $('estYear').value=''; $('prevBalance').value=''; $('ganpatiDonorName').value=''; // Clear donor name
    $('previewGroupLogo').src=''; $('previewGanpatiLogo').src='';
  }
  $('labelCurrentYear').textContent = currentYear;
}

function fileToBase64(file, cb){
  if(!file){ cb(null); return; }
  const reader = new FileReader();
  reader.onload = ()=>cb(reader.result);
  reader.readAsDataURL(file);
}

function saveInfo(){
  if(!currentUser) return alert('Please login');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.groupName = $('groupName').value || u.groupName;
  u.records = u.records || {};
  u.records[currentYear] = u.records[currentYear] || { group:{}, membersAmounts:{}, committee:[], expenses:[], signRoles:[] };
  const rec = u.records[currentYear];
  rec.group = rec.group || {};
  rec.group.est = $('estYear').value || rec.group.est || '';
  rec.group.prevBalance = parseFloat($('prevBalance').value) || 0;
  rec.group.moto = $('groupMoto').value || rec.group.moto || '';
  rec.group.ganpatiDonorName = $('ganpatiDonorName').value.trim() || ''; // Save donor name

  // process logo files asynchronously then save
  const gfile = $('groupLogoFile').files[0];
  const pfile = $('ganpatiLogoFile').files[0];

  let groupLogoProcessed = false;
  let ganpatiLogoProcessed = false;

  const checkAndSave = () => {
    if ( (gfile && !groupLogoProcessed) || (pfile && !ganpatiLogoProcessed) ) {
      return; // Still waiting for a logo to process
    }
    users[currentUser] = u;
    localStorage.setItem('users', JSON.stringify(users));
    alert('Info saved for '+currentYear);
    renderInfo();
    // also update header group name
    $('headerRight').innerHTML = `<strong>${u.groupName}</strong> &nbsp; <button class="btn-secondary small" onclick="doLogout()">Logout</button>`;
    renderYearsList();
  };

  if(gfile){
    fileToBase64(gfile, (b64)=>{
      if(b64) rec.group.groupLogo = b64;
      groupLogoProcessed = true;
      checkAndSave();
    });
  } else {
    groupLogoProcessed = true; // No file to process
  }

  if(pfile){
    fileToBase64(pfile, (b64p)=>{
      if(b64p) rec.group.ganpatiLogo = b64p;
      ganpatiLogoProcessed = true;
      checkAndSave();
    });
  } else {
    ganpatiLogoProcessed = true; // No file to process
  }

  // If no files were selected, trigger save immediately
  if (!gfile && !pfile) {
    checkAndSave();
  }
}

/* ========== Master Members and Year amounts ========= */
function addMasterMember(){
  if(!currentUser) return alert('Please login');
  const name = $('newMemberName').value.trim();
  const defaultAmt = $('newMemberAmount').value;
  if(!name) return alert('‡§®‡§æ‡§µ ‡§≠‡§∞‡§æ');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.masterMembers = u.masterMembers || [];
  // prevent duplicates
  if(u.masterMembers.some(m=>m.toLowerCase()===name.toLowerCase())) {
    alert('Member already exists');
  } else {
    u.masterMembers.push(name);
    // add key in all existing records with empty value
    Object.keys(u.records || {}).forEach(y=>{
      u.records[y].membersAmounts = u.records[y].membersAmounts || {};
      u.records[y].membersAmounts[name] = defaultAmt==="" ? "" : parseFloat(defaultAmt)||0;
    });
    users[currentUser] = u;
    localStorage.setItem('users', JSON.stringify(users));
    $('newMemberName').value=''; $('newMemberAmount').value='';
    renderMasterAndYearMembers();
    renderCommittee();
    renderYearsList();
  }
}

function renderMasterAndYearMembers(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.masterMembers = u.masterMembers || [];
  // master list UI
  const masterDiv = $('masterMembersList'); masterDiv.innerHTML = '';
  if(u.masterMembers.length===0) masterDiv.innerHTML = '<div class="muted">‡§Ö‡§¶‡•ç‡§Ø‡§æ‡§™ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§æ‡§π‡•Ä‡§§</div>';
  else u.masterMembers.forEach((m,idx)=>{
    const d = document.createElement('div'); d.className='row-item';
    d.innerHTML = `<div>${m}</div><div><button class="small" onclick="removeMasterMember(${idx})">Delete</button></div>`;
    masterDiv.appendChild(d);
  });

  // year amounts
  const yearDiv = $('membersForYear'); yearDiv.innerHTML = '';
  u.records = u.records || {};
  u.records[currentYear] = u.records[currentYear] || { group:{}, membersAmounts:{}, committee:[], expenses:[], signRoles:[] };
  const rec = u.records[currentYear];
  $('labelCurrentYear').textContent = currentYear;
  u.masterMembers.forEach((m,i)=>{
    // ensure key exists
    if(!(m in rec.membersAmounts)) rec.membersAmounts[m] = "";
    const val = rec.membersAmounts[m];
    const row = document.createElement('div'); row.className='row-item';
    row.innerHTML = `<div style="flex:1">${m}</div>
      <div style="width:160px;display:flex;gap:8px;align-items:center">
        <input type="number" id="amt_${i}" value="${val===null? '': val}" style="padding:6px;border:1px solid #ddd;border-radius:6px;width:100px"/>
        <button class="small" onclick="saveMemberAmount(${i})">Save</button>
      </div>`;
    yearDiv.appendChild(row);
  });
  // persist any new keys
  users[currentUser] = u; localStorage.setItem('users', JSON.stringify(users));
}

function saveMemberAmount(idx){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  const name = u.masterMembers[idx];
  const val = $(`amt_${idx}`).value;
  u.records = u.records || {};
  u.records[currentYear] = u.records[currentYear] || { group:{}, membersAmounts:{}, committee:[], expenses:[], signRoles:[] };
  u.records[currentYear].membersAmounts[name] = val==="" ? "" : parseFloat(val)||0;
  users[currentUser] = u; localStorage.setItem('users', JSON.stringify(users));
  alert(name + " ‡§ö‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•Ä");
}

function saveMembersForYear(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.records = u.records || {};
  u.records[currentYear] = u.records[currentYear] || { group:{}, membersAmounts:{}, committee:[], expenses:[], signRoles:[] };
  u.masterMembers.forEach((m,i)=>{
    const el = $(`amt_${i}`);
    if(el) u.records[currentYear].membersAmounts[m] = el.value==="" ? "" : parseFloat(el.value)||0;
  });
  users[currentUser] = u; localStorage.setItem('users', JSON.stringify(users));
  alert('‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§ö‡•á ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•á');
  renderYearsList();
}

/* remove master member */
function removeMasterMember(idx){
  if(!confirm('‡§π‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡§æ ‡§Ü‡§π‡•á ‡§ï‡§æ?')) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  const name = u.masterMembers.splice(idx,1)[0];
  // remove from all records
  Object.keys(u.records||{}).forEach(y=>{
    if(u.records[y].membersAmounts && (name in u.records[y].membersAmounts)) delete u.records[y].membersAmounts[name];
  });
  users[currentUser] = u; localStorage.setItem('users', JSON.stringify(users));
  renderMasterAndYearMembers(); renderCommittee(); renderYearsList();
}

/* ========== Committee ========== */
function addCommitteeMember(){
  if(!currentUser) return;
  const member = $('comMemberSelect').value;
  const role = $('comRoleSelect').value;
  if(!member) return alert('Member ‡§®‡§ø‡§µ‡§°‡§æ');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.records = u.records || {};
  u.records[currentYear] = u.records[currentYear] || { group:{}, membersAmounts:{}, committee:[], expenses:[], signRoles:[] };
  u.records[currentYear].committee.push({ name: member, role });
  users[currentUser] = u; localStorage.setItem('users', JSON.stringify(users));
  renderCommittee();
}

function renderCommittee(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.masterMembers = u.masterMembers || [];
  // fill member select
  $('comMemberSelect').innerHTML = u.masterMembers.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('') || '<option value="">(no members)</option>';
  // show current year's committee
  const rec = (u.records && u.records[currentYear]) ? u.records[currentYear] : { committee:[] };
  $('committeeList').innerHTML = (rec.committee||[]).map(c=>`<div class="row-item">${c.name} ‚Äî ${c.role} <button class="small" onclick="removeCommittee(${rec.committee.indexOf(c)})">Delete</button></div>`).join('') || '<div class="muted">Committee ‡§Æ‡§æ‡§π‡§ø‡§§ ‡§®‡§æ‡§π‡•Ä</div>';
}

function removeCommittee(index){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  if(rec && rec.committee && rec.committee[index]) rec.committee.splice(index,1);
  users[currentUser] = users[currentUser];
  localStorage.setItem('users', JSON.stringify(users));
  renderCommittee();
}

function saveCommittee(){ alert('Committee saved'); }

/* ========== Expenses ========== */
function addExpense(){
  if(!currentUser) return;
  const name = $('expenseName').value.trim();
  const a1 = parseFloat($('expenseAmt1').value) || 0;
  const a2 = parseFloat($('expenseAmt2').value) || 0;
  if(!name) return alert('‡§ñ‡§∞‡•ç‡§ö‡§æ‡§ö‡•á ‡§®‡§æ‡§µ ‡§≠‡§∞‡§æ');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.records = u.records || {};
  u.records[currentYear] = u.records[currentYear] || { group:{}, membersAmounts:{}, committee:[], expenses:[], signRoles:[] };
  u.records[currentYear].expenses.push({ name, a1, a2, total: a1+a2 });
  users[currentUser] = u; localStorage.setItem('users', JSON.stringify(users));
  $('expenseName').value=''; $('expenseAmt1').value=''; $('expenseAmt2').value='';
  renderExpensesList();
}

function renderExpensesList(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records && users[currentUser].records[currentYear] ? users[currentUser].records[currentYear] : { expenses:[] };
  $('expensesList').innerHTML = (rec.expenses||[]).map((e,i)=>`<div class="row-item">${e.name} ‚Äî ‚Çπ${(e.total||0).toFixed(2)} <button class="small" onclick="removeExpense(${i})">Delete</button></div>`).join('') || '<div class="muted">Expenses none</div>';
}

function removeExpense(i){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  if(rec && rec.expenses && rec.expenses[i]) rec.expenses.splice(i,1);
  users[currentUser] = users[currentUser];
  localStorage.setItem('users', JSON.stringify(users));
  renderExpensesList();
}

function saveExpenses(){ alert('Expenses saved'); }

/* ========== Sign roles ========== */
function addSignRole(){
  if(!currentUser) return;
  const r = $('signRoleInput').value.trim();
  if(!r) return alert('‡§™‡§¶ ‡§≠‡§∞‡§æ');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  users[currentUser].records = users[currentUser].records || {};
  users[currentUser].records[currentYear] = users[currentUser].records[currentYear] || { group:{}, membersAmounts:{}, committee:[], expenses:[], signRoles:[] };
  users[currentUser].records[currentYear].signRoles.push(r);
  localStorage.setItem('users', JSON.stringify(users));
  $('signRoleInput').value='';
  renderSignRolesList();
}

function renderSignRolesList(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records && users[currentUser].records[currentYear] ? users[currentUser].records[currentYear] : { signRoles:[] };
  $('signRolesList').innerHTML = (rec.signRoles||[]).map(s=>`<div class="row-item">${s} <button class="small" onclick="removeSignRole(${i})">Delete</button></div>`).join('') || '<div class="muted">No sign roles</div>';
}

function removeSignRole(i){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  if(rec && rec.signRoles && rec.signRoles[i]) rec.signRoles.splice(i,1);
  localStorage.setItem('users', JSON.stringify(users));
  renderSignRolesList();
}

/* ========== Report rendering ========== */
function renderReport(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  const rec = u.records && u.records[currentYear] ? u.records[currentYear] : { group:{}, membersAmounts:{}, committee:[], expenses:[], signRoles:[] };
  // logos and meta
  $('reportTitle').innerHTML = `<span class="report-group-name">${escapeHtml(u.groupName || '')}</span> ‚Äî ${currentYear}`;
  $('reportMoto').textContent = rec.group && rec.group.moto ? rec.group.moto : '';

  let metaHtml = '';
  if (rec.group && rec.group.est) {
    metaHtml += `<span class="report-meta-item">‡§∏‡•ç‡§•‡§æ‡§™‡§®‡§æ: ${rec.group.est}</span>`;
  }
  if (rec.group && rec.group.prevBalance) {
    metaHtml += `<span class="report-meta-item">‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§ö‡•Ä ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï: ‚Çπ${rec.group.prevBalance}</span>`;
  }
  if (rec.group && rec.group.ganpatiDonorName) {
    metaHtml += `<span class="report-meta-item">‡§ó‡§£‡§™‡§§‡•Ä ‡§Æ‡•Ç‡§∞‡•ç‡§§‡•Ä ‡§¶‡§æ‡§§‡•á: ${rec.group.ganpatiDonorName}</span>`;
  }
  $('reportMeta').innerHTML = metaHtml;
  
  $('reportGroupLogo').src = (rec.group && rec.group.groupLogo) ? rec.group.groupLogo : '';
  $('reportGanpatiLogo').src = (rec.group && rec.group.ganpatiLogo) ? rec.group.ganpatiLogo : '';

  // committee
  const tbodyC = $('reportCommittee').querySelector('tbody'); tbodyC.innerHTML = '';
  (rec.committee || []).forEach(c => { tbodyC.innerHTML += `<tr><td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.role)}</td></tr>`; });

  // financial summary
  const tbodyMS = $('reportMembersSummary').querySelector('tbody'); tbodyMS.innerHTML = '';
  let totalMemberAmount = 0;
  if (rec.membersAmounts) {
    for (const memberName in rec.membersAmounts) {
      const amount = parseFloat(rec.membersAmounts[memberName]);
      if (!isNaN(amount) && amount !== "") {
        totalMemberAmount += amount;
      }
    }
  }
  
  let totalExpenseAmount = 0;
  (rec.expenses || []).forEach(e => {
    totalExpenseAmount += (e.total || 0);
  });
  
  const prevBalance = (rec.group && rec.group.prevBalance) ? parseFloat(rec.group.prevBalance) : 0;
  const finalBalance = prevBalance + totalMemberAmount - totalExpenseAmount;
  
  tbodyMS.innerHTML += `<tr><td>‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§ö‡•Ä ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï</td><td>‚Çπ${prevBalance.toFixed(2)}</td></tr>`;
  tbodyMS.innerHTML += `<tr><td>‡§è‡§ï‡•Ç‡§£ ‡§µ‡§∞‡•ç‡§ó‡§£‡•Ä ‡§ú‡§Æ‡§æ</td><td>‚Çπ${totalMemberAmount.toFixed(2)}</td></tr>`;
  tbodyMS.innerHTML += `<tr><td>‡§è‡§ï‡•Ç‡§£ ‡§ñ‡§∞‡•ç‡§ö</td><td>‚Çπ${totalExpenseAmount.toFixed(2)}</td></tr>`;
  tbodyMS.innerHTML += `<tr><td><strong>‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï</strong></td><td><strong>‚Çπ${finalBalance.toFixed(2)}</strong></td></tr>`;


  // expenses
  const tbodyE = $('reportExpenses').querySelector('tbody'); tbodyE.innerHTML = '';
  (rec.expenses || []).forEach(e=> tbodyE.innerHTML += `<tr><td>${escapeHtml(e.name)}</td><td>‚Çπ${(e.total||0).toFixed(2)}</td></tr>`);

  // signatures
  $('reportSignatures').innerHTML = (rec.signRoles||[]).map(s=>`<div>${escapeHtml(s)} ____________________</div>`).join('');
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* ========== Dashboard list, load, delete, export/import ========== */
function renderYearsList(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const recs = users[currentUser].records || {};
  const el = $('yearsList'); el.innerHTML = '';
  const years = Object.keys(recs).sort((a,b)=>b-a);
  if(years.length===0){ el.innerHTML = '<div class="muted">‡§ï‡•ã‡§£‡•Ä‡§π‡•Ä ‡§µ‡§∞‡•ç‡§∑‡§æ‡§ö‡•á ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§®‡§æ‡§π‡•Ä‡§§. ‚ûï Add New Year ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§æ.</div>'; return; }
  years.forEach(y=>{
    const r = recs[y];
    const memCount = Object.keys(r.membersAmounts||{}).length;
    const expTotal = (r.expenses||[]).reduce((s,e)=>s+(e.total||0),0);
    const card = document.createElement('div'); card.className='dash-card';
    card.innerHTML = `<div><strong>${y}</strong></div><div class="muted">Members: ${memCount}</div><div class="muted">Expenses: ‚Çπ${expTotal.toFixed(2)}</div>
      <div style="margin-top:8px">
        <button class="small" onclick="loadYear('${y}'); navOpen('info');">Load</button> <button class="small" onclick="loadYearAndShow('${y}')">View Report</button>
        <button class="small" onclick="deleteYear('${y}')">Delete</button>
      </div>`;
    el.appendChild(card);
  });
}

function loadYearAndShow(y){ loadYear(y); navOpen('report'); }
function deleteYear(y){
  if(!confirm('‡§µ‡§∞‡•ç‡§∑ '+y+' delete ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•á?')) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  if(users[currentUser] && users[currentUser].records) delete users[currentUser].records[y];
  localStorage.setItem('users', JSON.stringify(users));
  renderYearsList();
}

/* ========== Utilities: Export/Import ========= */
function exportAll(){
  if(!currentUser) return alert('Login first');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const dataStr = JSON.stringify(users[currentUser], null, 2);
  const blob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `${currentUser}_data.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importPrompt(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = (e)=> {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try{
        const obj = JSON.parse(r.result);
        // merge into current user's records
        users = JSON.parse(localStorage.getItem('users')||'{}');
        if(!currentUser) { alert('Please login first to import into your group'); return; }
        users[currentUser] = obj;
        localStorage.setItem('users', JSON.stringify(users));
        alert('Import successful');
        renderYearsList();
      } catch(err){ alert('Invalid JSON'); }
    };
    r.readAsText(f);
  };
  inp.click();
}

/* ========== Initialization: start on register view ========== */
(function init(){
  users = JSON.parse(localStorage.getItem('users')||'{}');
  showSection('secRegister'); // Start on the register section
  // populate yearSelect
  populateYearSelect();
})();
</script>
</body>
</html>
