<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>‡§ó‡§£‡§™‡§§‡•Ä ‡§Æ‡§Ç‡§°‡§≥ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä ‚Äî Final</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhai+2:wght@700&family=Lekton:wght@700&family=Modak&family=Mukta:wght@700&family=Ruwudu:wght@400..700&family=Tiro+Devanagari+Marathi&family=Yatra+One&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:"Noto Sans Devanagari",sans-serif;background:#fffaf3;color:#222}
    header{background:linear-gradient(90deg,#ff7043,#ff9800);color:white;padding:12px 18px;font-weight:800;font-size:20px;display:flex;justify-content:space-between;align-items:center}
    nav{background:#fff3e0;padding:8px;display:flex;gap:8px;border-bottom:1px solid #f0d7b5; flex-wrap: wrap;}
    nav button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;background:transparent}
    nav .active{background:#ff7043;color:white}
    .container{max-width:1100px;margin:16px auto;padding:12px}
    .card{background:#fff;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.06);padding:14px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 220px;min-width:160px}
    label{display:block;font-size:13px;color:#444;margin-bottom:6px}
    input,select,textarea,button{font-size:14px}
    input,select,textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box}
    textarea{min-height:70px}
    button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:#169873;color:white}
    .btn-secondary{background:#999;color:white}
    .small{padding:6px 8px;font-size:13px}
    .list{margin-top:10px}
    .row-item{padding:8px;border:1px solid #eee;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .nested-list { margin-left: 20px; border-left: 2px solid #f0d7b5; padding-left: 10px; }
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #e8dcc0;padding:8px;text-align:left}
    th{background:#fff3d4}
    .dashboard{display:flex;gap:12px;flex-wrap:wrap}
    .dash-card{background:#fffef8;border:1px solid #f1d9a6;border-radius:8px;padding:10px;min-width:180px}
    .muted{color:#666;font-size:13px}
    .logo-row{display:flex;gap:12px;align-items:center}
    .logo-preview{max-height:80px;border:1px solid #eee;padding:6px;background:white}
    .report-group-name {
      color: #ff7043;
      font-size: 28px;
      font-family: 'Baloo Bhai 2', 'Noto Sans Devanagari', sans-serif;
      font-weight: 700;
    }
    .report-meta-item {
        display: block;
        margin-top: 4px;
    }
    .report-section-header {
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
      margin-top: 20px;
    }

    /* Print-specific styles for a systematic PDF report */
    @media print {
      @import url('https://fonts.googleapis.com/css2?family=Baloo+Bhai+2:wght@700&family=Lekton:wght@700&family=Modak&family=Mukta:wght@700&family=Ruwudu:wght@400..700&family=Tiro+Devanagari+Marathi&family=Yatra+One&display=swap');
      
      body {
        background: white !important;
        color: black !important;
        font-size: 12pt;
      }
      header, nav, #secRegister, #secLogin, #page-dashboard, #page-info, #page-members, #page-committee, #page-expenses, #page-signatures, #page-donations, .container > section > div:last-child {
        display: none !important; /* Hide UI elements */
      }
      #secApp, #page-report {
        display: block !important;
        margin: 0; padding: 0; max-width: none;
      }
      .container {
        margin: 0 auto; padding: 20px; max-width: 100%;
      }
      .card {
        box-shadow: none !important;
        border: 1px solid #ccc !important;
      }
      .report-group-name {
        color: black !important; /* Black color for formal report */
      }
      th {
          background-color: #f2f2f2 !important; /* Light grey for table headers */
          -webkit-print-color-adjust: exact; /* Ensures background color prints */
          color-adjust: exact;
      }
      tr, td, .row-item {
        page-break-inside: avoid !important; /* Avoids breaking table rows across pages */
      }
      .report-section-header {
        page-break-after: avoid !important;
        page-break-before: auto !important;
        border-bottom: 2px solid #999;
        margin-top: 28px;
      }
      #reportSignatures {
        page-break-inside: avoid !important;
      }
    }

    @media (max-width:720px){ .row{flex-direction:column} .logo-row{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <header>
    <div>‡§ó‡§£‡§™‡§§‡•Ä ‡§Æ‡§Ç‡§°‡§≥ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä</div>
    <div id="headerRight"></div>
  </header>

  <nav id="mainNav" style="display:none">
    <button onclick="navOpen('dashboard')" id="navDashboard">Dashboard</button>
    <button onclick="navOpen('info')" id="navInfo">Info</button>
    <button onclick="navOpen('members')" id="navMembers">Members</button>
    <button onclick="navOpen('committee')" id="navCommittee">Executive Committee</button>
    <button onclick="navOpen('donations')" id="navDonations">Donations</button>
    <button onclick="navOpen('expenses')" id="navExpenses">Expenses</button>
    <button onclick="navOpen('signatures')" id="navSign">Signatures</button>
    <button onclick="navOpen('report')" id="navReport">Report</button>
  </nav>

  <div class="container">

    <section id="secRegister" class="card">
      <h3>üìù ‡§®‡§µ‡•Ä‡§® Group Register ‡§ï‡§∞‡§æ</h3>
      <div class="row">
        <div class="col"><label>Group Name</label><input id="regGroup" placeholder="‡§â‡§¶‡§æ. ‡§ó‡§£‡§™‡§§‡•Ä ‡§Æ‡§Ç‡§°‡§≥"/></div>
        <div class="col"><label>Login ID</label><input id="regId" placeholder="‡§â‡§¶‡§æ. gangapti123"/></div>
        <div class="col"><label>Password</label><input id="regPass" type="password"/></div>
      </div>
      <div style="margin-top:10px">
        <button class="btn-primary" onclick="doRegister()">Register</button>
        <button class="btn-secondary" onclick="showSection('secLogin')">Login</button>
      </div>
      <p id="regMsg" class="muted"></p>
    </section>

    <section id="secLogin" class="card" style="display:none">
      <h3>üîë Login</h3>
      <div class="row">
        <div class="col"><label>Login ID</label><input id="loginId"/></div>
        <div class="col"><label>Password</label><input id="loginPass" type="password"/></div>
      </div>
      <div style="margin-top:10px">
        <button class="btn-primary" onclick="doLogin()">Login</button>
        <button class="btn-secondary" onclick="showSection('secRegister')">Register</button>
      </div>
      <p id="loginMsg" class="muted"></p>
    </section>

    <section id="secApp" style="display:none">

      <section id="page-dashboard" class="card">
        <h3>üìä Dashboard ‚Äî Year-wise Records</h3>
        <div style="margin-bottom:10px">
          <button class="btn-primary small" onclick="addYearPrompt()">‚ûï Add New Year</button>
          <button class="btn-secondary small" onclick="exportAll()">Export All (JSON)</button>
          <button class="btn-secondary small" onclick="importPrompt()">Import JSON</button>
        </div>
        <div id="yearsList" class="dashboard"></div>
      </section>

      <section id="page-info" class="card" style="display:none">
        <h3>‡§Æ‡§Ç‡§°‡§≥ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä (Group Info)</h3>
        <div class="row">
          <div class="col"><label>Group Name</label><input id="groupName"/></div>
          <div class="col"><label>Moto / ‡§â‡§¶‡•ç‡§¶‡•á‡§∂ (optional)</label><input id="groupMoto" placeholder="‡§â‡§¶‡§æ. ‡§∏‡•á‡§µ‡§æ ‡§µ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡•Ä"/></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>Group Logo (upload)</label>
            <input id="groupLogoFile" type="file" accept="image/*"/>
          </div>
          <div class="col">
            <label>Ganpati Logo (upload)</label>
            <input id="ganpatiLogoFile" type="file" accept="image/*"/>
          </div>
          <div class="col">
            <label>Year</label>
            <select id="yearSelect"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
            <div class="col"><label>‡§∏‡•ç‡§•‡§æ‡§™‡§®‡•á‡§ö‡§æ ‡§µ‡§∞‡•ç‡§∑</label><select id="estYear"></select></div>
            <div class="col"><label>‡§ó‡§£‡§™‡§§‡•Ä ‡§Æ‡•Ç‡§∞‡•ç‡§§‡•Ä ‡§¶‡•á‡§®‡§ó‡•Ä‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</label><input id="ganpatiDonorName" placeholder="‡§â‡§¶‡§æ. ‡§∂‡•ç‡§∞‡•Ä. ‡§™‡§æ‡§ü‡•Ä‡§≤"/></div>
        </div>
        <div class="row" style="margin-top:10px">
            <div class="col"><label>‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§ö‡•Ä ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï (‚Çπ)</label><input id="prevBalancePrincipal" type="number" oninput="updateTotalPrevBalance()"/></div>
            <div class="col"><label>‡§§‡•ç‡§Ø‡§æ‡§µ‡§∞‡•Ä‡§≤ ‡§µ‡•ç‡§Ø‡§æ‡§ú (‚Çπ) / Interest</label><input id="prevBalanceInterest" type="number" oninput="updateTotalPrevBalance()"/></div>
            <div class="col"><label>‡§è‡§ï‡•Ç‡§£ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï (Total Balance)</label><input id="prevBalanceTotalDisplay" type="text" readonly style="background:#eee; font-weight:bold;"/></div>
        </div>
        <input id="prevBalance" type="hidden"/>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>‡§Ö‡§π‡§µ‡§æ‡§≤ ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§´‡•â‡§®‡•ç‡§ü (Report Title Font)</label>
            <select id="groupFontSelect">
              <option value="'Baloo Bhai 2', 'Noto Sans Devanagari', sans-serif">Baloo Bhai 2 (Default)</option>
              <option value="'Modak', 'Noto Sans Devanagari', cursive">Modak</option>
              <option value="'Yatra One', 'Noto Sans Devanagari', cursive">Yatra One</option>
              <option value="'Mukta', 'Noto Sans Devanagari', sans-serif">Mukta</option>
              <option value="'Tiro Devanagari Marathi', 'Noto Sans Devanagari', sans-serif">Tiro Devanagari Marathi</option>
              <option value="'Ruwudu', 'Noto Sans Devanagari', serif">Ruwudu</option>
              <option value="'Lekton', 'Noto Sans Devanagari', sans-serif">Lekton</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col" style="display:flex;align-items:flex-end;gap:8px">
            <button class="btn-primary" onclick="saveInfo()">Save Info</button>
            <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
          </div>
        </div>

        <div style="margin-top:12px" class="logo-row">
          <div>
            <div class="muted">Preview Group Logo</div>
            <img id="previewGroupLogo" class="logo-preview" src="" alt="" />
          </div>
          <div>
            <div class="muted">Preview Ganpati Logo</div>
            <img id="previewGanpatiLogo" class="logo-preview" src="" alt="" />
          </div>
        </div>
      </section>

      <section id="page-members" class="card" style="display:none">
        <h3>‡§∏‡§¶‡§∏‡•ç‡§Ø (Master list + Year-wise amounts)</h3>
        <div class="row">
          <div class="col"><label>Member Name</label><input id="newMemberName" placeholder="‡§®‡§æ‡§µ"/></div>
          <div class="col"><label>Default Amount (optional)</label><input id="newMemberAmount" type="number" placeholder="‚Çπ"/></div>
          <div class="col" style="display:flex;align-items:flex-end"><button class="btn-primary" onclick="addMasterMember()">Add Member</button></div>
        </div>

        <div style="margin-top:15px">
          <h4>Master Members (for group)</h4>
          <div id="masterMembersList" class="list"></div>
        </div>

        <div style="margin-top:12px">
          <h4>This year's amounts ‚Äî <span id="labelCurrentYear"></span></h4>
          <div id="membersForYear" class="list"></div>
          <div style="margin-top:10px">
            <button class="btn-primary" onclick="saveMembersForYear()">Save This Year's Amounts</button>
            <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
          </div>
        </div>
      </section>

      <section id="page-committee" class="card" style="display:none">
        <h3>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§Æ‡§ø‡§§‡•Ä (Executive Committee)</h3>
        <div class="row">
          <div class="col"><label>Member</label><select id="comMemberSelect"></select></div>
          <div class="col"><label>Role</label><select id="comRoleSelect"><option>‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑</option><option>‡§â‡§™‡§æ‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑</option><option>‡§ñ‡§ú‡§ø‡§®‡§¶‡§æ‡§∞</option><option>‡§∏‡§ö‡§ø‡§µ</option><option>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑</option></select></div>
          <div class="col" style="display:flex;align-items:flex-end"><button class="btn-primary" onclick="addCommitteeMember()">Add to Committee</button></div>
        </div>

        <div style="margin-top:15px">
          <h4>This year's committee</h4>
          <div id="committeeList" class="list"></div>
          <div style="margin-top:10px">
            <button class="btn-primary" onclick="saveCommittee()">Save Committee</button>
            <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
          </div>
        </div>
      </section>

      <section id="page-donations" class="card" style="display:none">
        <h3>‡§¶‡•á‡§£‡§ó‡•Ä (Donations)</h3>
        <div class="row">
            <div class="col"><label>‡§¶‡•á‡§£‡§ó‡•Ä‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ (Donor Name)</label><input id="donorName" placeholder="‡§â‡§¶‡§æ. ‡§∂‡•ç‡§∞‡•Ä. ‡§ú‡•ã‡§∂‡•Ä"/></div>
            <div class="col">
                <label>‡§¶‡•á‡§£‡§ó‡•Ä‡§ö‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ (Donation Type)</label>
                <select id="donationType" onchange="toggleDonationFields()">
                    <option value="cash">‡§∞‡§ï‡•ç‡§ï‡§Æ / Cash</option>
                    <option value="item">‡§µ‡§∏‡•ç‡§§‡•Ç / Item</option>
                </select>
            </div>
        </div>
        <div class="row" id="cashDonationFields">
            <div class="col"><label>‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</label><input id="donationAmount" type="number"/></div>
        </div>
        <div class="row" id="itemDonationFields" style="display:none;">
            <div class="col"><label>‡§µ‡§∏‡•ç‡§§‡•Ç‡§ö‡•á ‡§®‡§æ‡§µ (Item Name)</label><input id="itemName" placeholder="‡§â‡§¶‡§æ. ‡§§‡§æ‡§Ç‡§¶‡•Ç‡§≥ ‡•´‡•¶ ‡§ï‡§ø‡§≤‡•ã"/></div>
            <div class="col"><label>‡§Ö‡§Ç‡§¶‡§æ‡§ú‡•á ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ) (Approx. Value)</label><input id="itemValue" type="number"/></div>
        </div>
        <div style="margin-top:10px">
            <button class="btn-primary" onclick="addDonation()">Add Donation</button>
            <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
        </div>
        <div style="margin-top:15px">
            <h4>‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§§‡•Ä‡§≤ ‡§¶‡•á‡§£‡§ó‡•ç‡§Ø‡§æ (This Year's Donations)</h4>
            <div id="donationsList" class="list"></div>
        </div>
      </section>

      <section id="page-expenses" class="card" style="display:none">
        <h3>‡§ñ‡§∞‡•ç‡§ö</h3>
        <div class="row">
          <div class="col"><label>Expense Group Name</label><input id="newExpenseGroupName" placeholder="‡§â‡§¶‡§æ. ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§ñ‡§∞‡•ç‡§ö"/></div>
          <div class="col" style="display:flex;align-items:flex-end"><button class="btn-primary" onclick="addExpenseGroup()">Add Expense Group</button></div>
        </div>

        <div style="margin-top:15px">
          <h4>Add Individual Expense</h4>
          <div class="row">
            <div class="col"><label>Select Group</label><select id="expenseGroupSelect"></select></div>
            <div class="col"><label>Expense Item Name</label><input id="expenseItemName" placeholder="‡§â‡§¶‡§æ. ‡§π‡§æ‡§∞"/></div>
            <div class="col"><label>Amount 1</label><input id="expenseAmt1" type="number"/></div>
            <div class="col"><label>Amount 2</label><input id="expenseAmt2" type="number"/></div>
            <div class="col" style="display:flex;align-items:flex-end"><button class="btn-primary" onclick="addExpenseItem()">Add Expense Item</button></div>
          </div>
        </div>

        <div style="margin-top:12px">
          <h4>This year's expenses by group</h4>
          <div id="expensesList" class="list"></div>
          <div style="margin-top:10px">
            <button class="btn-primary" onclick="saveExpenses()">Save Expenses</button>
            <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
          </div>
        </div>
      </section>

      <section id="page-signatures" class="card" style="display:none">
        <h3>‡§∏‡•ç‡§µ‡§æ‡§ï‡•ç‡§∑‡§∞‡•Ä ‡§™‡§¶‡•á</h3>
        <div class="row">
          <div class="col"><label>Role</label><input id="signRoleInput" placeholder="‡§â‡§¶‡§æ. ‡§Ö‡§ß‡•ç‡§Ø‡§ï‡•ç‡§∑"/></div>
          <div class="col" style="display:flex;align-items:flex-end"><button class="btn-primary" onclick="addSignRole()">Add</button></div>
        </div>

        <div style="margin-top:12px">
          <h4>This year's sign roles</h4>
          <div id="signRolesList" class="list"></div>
          <div style="margin-top:10px"><button class="btn-secondary" onclick="navOpen('dashboard')">Back</button></div>
        </div>
      </section>

      <section id="page-report" class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="flex: 1 1 0;">
                <img id="reportGroupLogo" class="logo-preview" src="" alt="Group Logo" />
            </div>
            <div style="flex: 2 1 0; text-align: center;">
                <h2 id="reportTitle" style="margin: 0 0 4px 0;"></h2>
                <div id="reportMoto" class="muted"></div>
                <div id="reportMeta" class="muted"></div>
            </div>
            <div style="flex: 1 1 0; text-align: right;">
                <img id="reportGanpatiLogo" class="logo-preview" src="" alt="Ganpati Logo" />
            </div>
        </div>

        <h4 class="report-section-header">‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§Æ‡§ø‡§§‡•Ä</h4>
        <table id="reportCommittee"><thead><tr><th>‡§®‡§æ‡§µ</th><th>‡§™‡§¶</th></tr></thead><tbody></tbody></table>

        <h4 class="report-section-header">‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</h4>
        <table id="reportMembersSummary"><thead><tr><th>‡§µ‡§∞‡•ç‡§£‡§®</th><th>‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</th></tr></thead><tbody></tbody></table>
        
        <h4 class="report-section-header">‡§¶‡•á‡§£‡§ó‡•Ä (Donations)</h4>
        <table id="reportDonations"><thead><tr><th>‡§¶‡•á‡§£‡§ó‡•Ä‡§¶‡§æ‡§∞</th><th>‡§¶‡•á‡§£‡§ó‡•Ä (‡§µ‡§∏‡•ç‡§§‡•Ç / ‡§∞‡§ï‡•ç‡§ï‡§Æ)</th><th>‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ)</th></tr></thead><tbody></tbody></table>

        <h4 class="report-section-header">‡§ñ‡§∞‡•ç‡§ö</h4>
        <table id="reportExpenses"><thead><tr><th>‡§ñ‡§∞‡•ç‡§ö ‡§ó‡§ü</th><th>‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</th></tr></thead><tbody></tbody></table>

        <h4 class="report-section-header">‡§∏‡•ç‡§µ‡§æ‡§ï‡•ç‡§∑‡§±‡•ç‡§Ø‡§æ</h4>
        <table id="reportSignatures" style="margin-top: 25px; border: none;">
            <tbody></tbody>
        </table>
        
        <div id="reportGeneratedDate" class="muted" style="text-align: right; margin-top: 20px; font-size: 12px;"></div>

        <div style="margin-top:12px">
          <button class="btn-primary" onclick="window.print()">Print / Save PDF</button>
          <button class="btn-secondary" onclick="navOpen('dashboard')">Back</button>
        </div>
      </section>

    </section>
  </div>

<script>
/* Data model stored under localStorage.users keyed by loginId
users = {
  [id]: {
    password: "...",
    groupName: "...",
    masterMembers: ["A","B",...],
    records: {
      "2025": {
         group: { est, prevBalance, prevBalancePrincipal, prevBalanceInterest, moto, groupLogo (base64), ganpatiLogo (base64), ganpatiDonorName, fontStyle },
         membersAmounts: { "A":100, "B":200, ... },
         committee: [{name,role},...],
         donations: [{donorName, type, amount, itemName, itemValue},...],
         expenseGroups: { "‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§ñ‡§∞‡•ç‡§ö": [{name:"‡§π‡§æ‡§∞", a1:500, a2:0, total:500}] },
         signRoles: [...]
      }, ...
    }
  }
}
*/

let users = JSON.parse(localStorage.getItem("users") || "{}");
let currentUser = null;
let currentYear = new Date().getFullYear().toString();

// helper
const $ = id => document.getElementById(id);

function showSection(sec){
  ['secRegister','secLogin','secApp'].forEach(s=>{
    $(s).style.display = 'none';
  });
  $(sec).style.display = 'block';
}

// navigation within app pages
function navOpen(page){
  $('secApp').style.display = 'block';
  ['page-dashboard','page-info','page-members','page-committee','page-donations','page-expenses','page-signatures','page-report'].forEach(p=>$(p).style.display='none');
  $(`page-${page}`).style.display = 'block';
  document.querySelectorAll('#mainNav button').forEach(b=>b.classList.remove('active'));
  document.querySelector(`#nav${capitalize(page)}`)?.classList.add('active');

  if(page==='dashboard') renderYearsList();
  if(page==='info') renderInfo();
  if(page==='members') renderMasterAndYearMembers();
  if(page==='committee') renderCommittee();
  if(page==='donations') renderDonations();
  if(page==='expenses') renderExpensesUI();
  if(page==='signatures') renderSignRolesList();
  if(page==='report') renderReport();
}
function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

/* ========== Auth & initial UI ========== */
function doRegister(){
  const g = $('regGroup').value.trim();
  const id = $('regId').value.trim();
  const pass = $('regPass').value;
  if(!g || !id || !pass){ $('regMsg').textContent = '‡§∏‡§∞‡•ç‡§µ ‡§´‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡§æ'; return; }
  users = JSON.parse(localStorage.getItem('users')||'{}');
  if(users[id]){ $('regMsg').textContent = '‡§π‡§æ ID ‡§Ü‡§ß‡•Ä‡§ö ‡§Ü‡§π‡•á'; return; }
  users[id] = { password: pass, groupName: g, masterMembers: [], records: {} };
  localStorage.setItem('users', JSON.stringify(users));
  $('regMsg').textContent = 'Registered. Now login.';
  $('regGroup').value=''; $('regId').value=''; $('regPass').value='';
  showSection('secLogin');
}
function doLogin(){
  const id = $('loginId').value.trim();
  const pass = $('loginPass').value;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  if(users[id] && users[id].password === pass){
    currentUser = id;
    $('mainNav').style.display = 'flex';
    $('headerRight').innerHTML = `<strong>${users[id].groupName || id}</strong> &nbsp; <button class="btn-secondary small" onclick="doLogout()">Logout</button>`;
    populateYearSelect();
    if(!users[currentUser].records) users[currentUser].records = {};
    if(!users[currentUser].records[currentYear]) {
      users[currentUser].records[currentYear] = { group:{}, membersAmounts:{}, committee:[], donations:[], expenseGroups:{}, signRoles:[] };
      localStorage.setItem('users', JSON.stringify(users));
    }
    showSection('secApp');
    navOpen('dashboard');
    $('loginId').value=''; $('loginPass').value='';
  } else {
    $('loginMsg').textContent = 'Login failed ‚Äî ID ‡§ï‡§ø‡§Ç‡§µ‡§æ Password ‡§§‡§™‡§æ‡§∏‡§æ';
  }
}
function doLogout(){
  currentUser = null;
  $('mainNav').style.display = 'none';
  $('headerRight').innerHTML = '';
  showSection('secLogin');
}

/* ========== Year selection helpers ========== */
function populateYearSelect(){
  const sel = $('yearSelect');
  sel.innerHTML = '';
  const cur = new Date().getFullYear();
  for(let y=1950;y<=2050;y++){
    const opt = document.createElement('option'); opt.value = String(y); opt.textContent = String(y);
    if(String(y)===currentYear) opt.selected = true;
    sel.appendChild(opt);
  }
  const ey = $('estYear'); ey.innerHTML = '';
  for(let y=1950;y<=2050;y++){ const o=document.createElement('option');o.value=String(y);o.textContent=String(y); ey.appendChild(o); }
  sel.onchange = function(){ currentYear = sel.value;
    if(currentUser) loadYear(currentYear);
    renderMasterAndYearMembers();
  }
}

/* ========== Year records management ========= */
function addYearPrompt(){
  if(!currentUser) return alert('‡§ï‡•É‡§™‡§Ø‡§æ login ‡§ï‡§∞‡§æ');
  let y = prompt('‡§®‡§µ‡•Ä‡§® ‡§µ‡§∞‡•ç‡§∑ ‡§ü‡§æ‡§ï‡§æ (‡§â‡§¶‡§æ. 2025)');
  if(!y) return;
  y = String(y);
  users = JSON.parse(localStorage.getItem('users')||'{}');
  if(!users[currentUser]) return alert('user missing');
  if(users[currentUser].records && users[currentUser].records[y]) return alert('‡§π‡•Ä ‡§µ‡§∞‡•ç‡§∑ ‡§Ü‡§ß‡•Ä‡§ö ‡§Ü‡§π‡•á');
  users[currentUser].records = users[currentUser].records || {};
  const prevYear = Object.keys(users[currentUser].records).sort().reverse()[0];
  const newRec = { group: {}, membersAmounts: {}, committee: [], donations: [], expenseGroups: {}, signRoles: [] };
  users[currentUser].masterMembers = users[currentUser].masterMembers || [];
  users[currentUser].masterMembers.forEach(m=>{
    newRec.membersAmounts[m] = "";
  });
  users[currentUser].records[y] = newRec;
  localStorage.setItem('users', JSON.stringify(users));
  loadYear(y);
  renderYearsList();
  navOpen('members');
}

function loadYear(y){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  currentYear = String(y);
  if(!users[currentUser].records) users[currentUser].records = {};
  if(!users[currentUser].records[currentYear]) {
    users[currentUser].records[currentYear] = { group:{}, membersAmounts:{}, committee:[], donations:[], expenseGroups:{}, signRoles:[] };
  }
  users[currentUser].masterMembers = users[currentUser].masterMembers || [];
  users[currentUser].masterMembers.forEach(m => {
    if(!(m in users[currentUser].records[currentYear].membersAmounts)) users[currentUser].records[currentYear].membersAmounts[m] = "";
  });
  localStorage.setItem('users', JSON.stringify(users));
  populateYearSelect();
  $('yearSelect').value = currentYear;
  renderMasterAndYearMembers();
  renderCommittee();
  renderDonations();
  renderExpensesUI();
  renderSignRolesList();
  renderInfo();
  renderYearsList();
}

/* ========== Info save (logos, moto) ========== */
function updateTotalPrevBalance() {
    const principal = parseFloat($('prevBalancePrincipal').value) || 0;
    const interest = parseFloat($('prevBalanceInterest').value) || 0;
    const total = principal + interest;
    $('prevBalance').value = total; // Update hidden field for saving
    $('prevBalanceTotalDisplay').value = `‚Çπ ${total.toFixed(2)}`; // Update display field
}

function renderInfo(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  $('groupName').value = u.groupName || '';
  const rec = u.records && u.records[currentYear] ? u.records[currentYear] : null;
  const defaultFont = "'Baloo Bhai 2', 'Noto Sans Devanagari', sans-serif";
  if(rec && rec.group){
    $('groupMoto').value = rec.group.moto || '';
    $('estYear').value = rec.group.est || '';
    $('prevBalancePrincipal').value = rec.group.prevBalancePrincipal || '';
    $('prevBalanceInterest').value = rec.group.prevBalanceInterest || '';
    $('ganpatiDonorName').value = rec.group.ganpatiDonorName || '';
    $('groupFontSelect').value = rec.group.fontStyle || defaultFont;
    $('previewGroupLogo').src = rec.group.groupLogo || '';
    $('previewGanpatiLogo').src = rec.group.ganpatiLogo || '';
  } else {
    $('groupMoto').value=''; $('estYear').value='';
    $('prevBalancePrincipal').value = ''; $('prevBalanceInterest').value = '';
    $('ganpatiDonorName').value='';
    $('groupFontSelect').value = defaultFont;
    $('previewGroupLogo').src=''; $('previewGanpatiLogo').src='';
  }
  updateTotalPrevBalance();
  $('labelCurrentYear').textContent = currentYear;
}

function fileToBase64(file, cb){
  if(!file){ cb(null); return; }
  const reader = new FileReader();
  reader.onload = ()=>cb(reader.result);
  reader.readAsDataURL(file);
}

function saveInfo(){
  if(!currentUser) return alert('Please login');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.groupName = $('groupName').value || u.groupName;
  u.records = u.records || {};
  u.records[currentYear] = u.records[currentYear] || { group:{}, membersAmounts:{}, committee:[], donations:[], expenseGroups:{}, signRoles:[] };
  const rec = u.records[currentYear];
  rec.group = rec.group || {};
  rec.group.est = $('estYear').value || rec.group.est || '';
  rec.group.prevBalancePrincipal = parseFloat($('prevBalancePrincipal').value) || 0;
  rec.group.prevBalanceInterest = parseFloat($('prevBalanceInterest').value) || 0;
  rec.group.prevBalance = rec.group.prevBalancePrincipal + rec.group.prevBalanceInterest;
  rec.group.moto = $('groupMoto').value || rec.group.moto || '';
  rec.group.ganpatiDonorName = $('ganpatiDonorName').value.trim() || '';
  rec.group.fontStyle = $('groupFontSelect').value;

  const gfile = $('groupLogoFile').files[0];
  const pfile = $('ganpatiLogoFile').files[0];
  let groupLogoProcessed = !gfile;
  let ganpatiLogoProcessed = !pfile;

  const checkAndSave = () => {
    if (!groupLogoProcessed || !ganpatiLogoProcessed) return;
    users[currentUser] = u;
    localStorage.setItem('users', JSON.stringify(users));
    alert('Info saved for '+currentYear);
    renderInfo();
    $('headerRight').innerHTML = `<strong>${u.groupName}</strong> &nbsp; <button class="btn-secondary small" onclick="doLogout()">Logout</button>`;
    renderYearsList();
  };

  if(gfile){
    fileToBase64(gfile, (b64)=>{
      if(b64) rec.group.groupLogo = b64;
      groupLogoProcessed = true;
      checkAndSave();
    });
  }

  if(pfile){
    fileToBase64(pfile, (b64p)=>{
      if(b64p) rec.group.ganpatiLogo = b64p;
      ganpatiLogoProcessed = true;
      checkAndSave();
    });
  }

  if (!gfile && !pfile) {
    checkAndSave();
  }
}

/* ========== Master Members and Year amounts ========= */
function addMasterMember(){
  if(!currentUser) return alert('Please login');
  const name = $('newMemberName').value.trim();
  const defaultAmt = $('newMemberAmount').value;
  if(!name) return alert('‡§®‡§æ‡§µ ‡§≠‡§∞‡§æ');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.masterMembers = u.masterMembers || [];
  if(u.masterMembers.some(m=>m.toLowerCase()===name.toLowerCase())) {
    alert('Member already exists');
  } else {
    u.masterMembers.push(name);
    Object.keys(u.records || {}).forEach(y=>{
      u.records[y].membersAmounts = u.records[y].membersAmounts || {};
      u.records[y].membersAmounts[name] = defaultAmt==="" ? "" : parseFloat(defaultAmt)||0;
    });
    users[currentUser] = u;
    localStorage.setItem('users', JSON.stringify(users));
    $('newMemberName').value=''; $('newMemberAmount').value='';
    renderMasterAndYearMembers();
    renderCommittee();
    renderYearsList();
  }
}

function renderMasterAndYearMembers(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.masterMembers = u.masterMembers || [];
  const masterDiv = $('masterMembersList'); masterDiv.innerHTML = '';
  if(u.masterMembers.length===0) masterDiv.innerHTML = '<div class="muted">‡§Ö‡§¶‡•ç‡§Ø‡§æ‡§™ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§®‡§æ‡§π‡•Ä‡§§</div>';
  else u.masterMembers.forEach((m,idx)=>{
    const d = document.createElement('div'); d.className='row-item';
    d.innerHTML = `<div>${m}</div><div><button class="small" onclick="removeMasterMember(${idx})">Delete</button></div>`;
    masterDiv.appendChild(d);
  });

  const yearDiv = $('membersForYear'); yearDiv.innerHTML = '';
  u.records = u.records || {};
  u.records[currentYear] = u.records[currentYear] || { group:{}, membersAmounts:{}, committee:[], donations:[], expenseGroups:{}, signRoles:[] };
  const rec = u.records[currentYear];
  $('labelCurrentYear').textContent = currentYear;
  u.masterMembers.forEach((m,i)=>{
    if(!(m in rec.membersAmounts)) rec.membersAmounts[m] = "";
    const val = rec.membersAmounts[m];
    const row = document.createElement('div'); row.className='row-item';
    row.innerHTML = `<div style="flex:1">${m}</div>
      <div style="width:160px;display:flex;gap:8px;align-items:center">
        <input type="number" id="amt_${i}" value="${val===null? '': val}" style="padding:6px;border:1px solid #ddd;border-radius:6px;width:100px"/>
        <button class="small" onclick="saveMemberAmount(${i})">Save</button>
      </div>`;
    yearDiv.appendChild(row);
  });
  users[currentUser] = u; localStorage.setItem('users', JSON.stringify(users));
}

function saveMemberAmount(idx){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  const name = u.masterMembers[idx];
  const val = $(`amt_${idx}`).value;
  u.records[currentYear].membersAmounts[name] = val==="" ? "" : parseFloat(val)||0;
  localStorage.setItem('users', JSON.stringify(users));
  alert(name + " ‡§ö‡•Ä ‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•Ä");
}

function saveMembersForYear(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.masterMembers.forEach((m,i)=>{
    const el = $(`amt_${i}`);
    if(el) u.records[currentYear].membersAmounts[m] = el.value==="" ? "" : parseFloat(el.value)||0;
  });
  localStorage.setItem('users', JSON.stringify(users));
  alert('‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§ö‡•á ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•á');
  renderYearsList();
}

function removeMasterMember(idx){
  if(!confirm('‡§π‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡§æ ‡§Ü‡§π‡•á ‡§ï‡§æ?')) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  const name = u.masterMembers.splice(idx,1)[0];
  Object.keys(u.records||{}).forEach(y=>{
    if(u.records[y].membersAmounts && (name in u.records[y].membersAmounts)) delete u.records[y].membersAmounts[name];
  });
  localStorage.setItem('users', JSON.stringify(users));
  renderMasterAndYearMembers(); renderCommittee(); renderYearsList();
}

/* ========== Committee ========== */
function addCommitteeMember(){
  if(!currentUser) return;
  const member = $('comMemberSelect').value;
  const role = $('comRoleSelect').value;
  if(!member) return alert('Member ‡§®‡§ø‡§µ‡§°‡§æ');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  u.records[currentYear].committee.push({ name: member, role });
  localStorage.setItem('users', JSON.stringify(users));
  renderCommittee();
}

function renderCommittee(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  $('comMemberSelect').innerHTML = (u.masterMembers || []).map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('') || '<option value="">(no members)</option>';
  const rec = (u.records && u.records[currentYear]) ? u.records[currentYear] : { committee:[] };
  $('committeeList').innerHTML = (rec.committee||[]).map(c=>`<div class="row-item">${c.name} ‚Äî ${c.role} <button class="small" onclick="removeCommittee(${rec.committee.indexOf(c)})">Delete</button></div>`).join('') || '<div class="muted">Committee ‡§Æ‡§æ‡§π‡§ø‡§§ ‡§®‡§æ‡§π‡•Ä</div>';
}

function removeCommittee(index){
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  if(rec && rec.committee) rec.committee.splice(index,1);
  localStorage.setItem('users', JSON.stringify(users));
  renderCommittee();
}

function saveCommittee(){ alert('Committee saved'); }

/* ========== Donations ========== */
function toggleDonationFields() {
    const type = $('donationType').value;
    $('cashDonationFields').style.display = (type === 'cash') ? 'flex' : 'none';
    $('itemDonationFields').style.display = (type === 'item') ? 'flex' : 'none';
}

function addDonation() {
    if(!currentUser) return;
    users = JSON.parse(localStorage.getItem('users')||'{}');
    const rec = users[currentUser].records[currentYear];
    
    const donorName = $('donorName').value.trim();
    const type = $('donationType').value;
    if (!donorName) return alert('‡§¶‡•á‡§£‡§ó‡•Ä‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ ‡§≠‡§∞‡§æ');

    const newDonation = { donorName, type };

    if (type === 'cash') {
        const amount = parseFloat($('donationAmount').value) || 0;
        if (amount <= 0) return alert('‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§≠‡§∞‡§æ');
        newDonation.amount = amount;
    } else { // type === 'item'
        const itemName = $('itemName').value.trim();
        const itemValue = parseFloat($('itemValue').value) || 0;
        if (!itemName || itemValue <= 0) return alert('‡§µ‡§∏‡•ç‡§§‡•Ç‡§ö‡•á ‡§®‡§æ‡§µ ‡§Ü‡§£‡§ø ‡§Ö‡§Ç‡§¶‡§æ‡§ú‡•á ‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§≠‡§∞‡§æ');
        newDonation.itemName = itemName;
        newDonation.itemValue = itemValue;
    }

    rec.donations = rec.donations || [];
    rec.donations.push(newDonation);
    localStorage.setItem('users', JSON.stringify(users));
    
    $('donorName').value = '';
    $('donationAmount').value = '';
    $('itemName').value = '';
    $('itemValue').value = '';

    renderDonations();
}

function renderDonations() {
    if(!currentUser) return;
    users = JSON.parse(localStorage.getItem('users')||'{}');
    const rec = users[currentUser].records[currentYear] || { donations: [] };
    const donations = rec.donations || [];
    const listDiv = $('donationsList');
    listDiv.innerHTML = '';

    if (donations.length === 0) {
        listDiv.innerHTML = '<div class="muted">‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä ‡§¶‡•á‡§£‡§ó‡•Ä ‡§®‡§æ‡§π‡•Ä.</div>';
        return;
    }

    donations.forEach((d, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'row-item';
        const description = d.type === 'cash' 
            ? `‡§∞‡§ï‡•ç‡§ï‡§Æ: ‚Çπ ${d.amount.toFixed(2)}` 
            : `‡§µ‡§∏‡•ç‡§§‡•Ç: ${escapeHtml(d.itemName)} (‡§Ö‡§Ç‡§¶‡§æ‡§ú‡•á ‚Çπ ${d.itemValue.toFixed(2)})`;
        itemDiv.innerHTML = `
            <div><strong>${escapeHtml(d.donorName)}</strong> ‚Äî ${description}</div>
            <div><button class="small" onclick="removeDonation(${index})">Delete</button></div>`;
        listDiv.appendChild(itemDiv);
    });
}

function removeDonation(index) {
    if(!confirm('‡§π‡•Ä ‡§¶‡•á‡§£‡§ó‡•Ä ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡•Ä ‡§Ü‡§π‡•á ‡§ï‡§æ?')) return;
    users = JSON.parse(localStorage.getItem('users')||'{}');
    const rec = users[currentUser].records[currentYear];
    if (rec && rec.donations) {
        rec.donations.splice(index, 1);
        localStorage.setItem('users', JSON.stringify(users));
        renderDonations();
    }
}


/* ========== Expenses (Regrouped) ========== */
function addExpenseGroup(){
  if(!currentUser) return alert('Please login');
  const groupName = $('newExpenseGroupName').value.trim();
  if(!groupName) return alert('‡§ñ‡§∞‡•ç‡§ö ‡§ó‡§ü ‡§®‡§æ‡§µ ‡§≠‡§∞‡§æ');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  rec.expenseGroups = rec.expenseGroups || {};
  if(rec.expenseGroups[groupName]){ return alert('‡§π‡§æ ‡§ñ‡§∞‡•ç‡§ö ‡§ó‡§ü ‡§Ü‡§ß‡•Ä‡§ö ‡§Ö‡§∏‡•ç‡§§‡§ø‡§§‡•ç‡§µ‡§æ‡§§ ‡§Ü‡§π‡•á.'); }
  rec.expenseGroups[groupName] = [];
  localStorage.setItem('users', JSON.stringify(users));
  $('newExpenseGroupName').value = '';
  renderExpensesUI();
}

function addExpenseItem(){
  if(!currentUser) return alert('Please login');
  const groupName = $('expenseGroupSelect').value;
  const itemName = $('expenseItemName').value.trim();
  const a1 = parseFloat($('expenseAmt1').value) || 0;
  const a2 = parseFloat($('expenseAmt2').value) || 0;
  if(!groupName) return alert('‡§ñ‡§∞‡•ç‡§ö ‡§ó‡§ü ‡§®‡§ø‡§µ‡§°‡§æ');
  if(!itemName) return alert('‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§∏‡•ç‡§§‡•Ç‡§ö‡•á ‡§®‡§æ‡§µ ‡§≠‡§∞‡§æ');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  if(!rec.expenseGroups[groupName]){ return alert('‡§®‡§ø‡§µ‡§°‡§≤‡•á‡§≤‡§æ ‡§ñ‡§∞‡•ç‡§ö ‡§ó‡§ü ‡§Ö‡§∏‡•ç‡§§‡§ø‡§§‡•ç‡§µ‡§æ‡§§ ‡§®‡§æ‡§π‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•ã ‡§Ü‡§ß‡•Ä ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ.'); }
  rec.expenseGroups[groupName].push({ name: itemName, a1, a2, total: a1 + a2 });
  localStorage.setItem('users', JSON.stringify(users));
  $('expenseItemName').value = ''; $('expenseAmt1').value = ''; $('expenseAmt2').value = '';
  renderExpensesUI();
}

function renderExpensesUI(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  rec.expenseGroups = rec.expenseGroups || {};
  const groupSelect = $('expenseGroupSelect');
  groupSelect.innerHTML = '<option value="">-- ‡§ó‡§ü ‡§®‡§ø‡§µ‡§°‡§æ --</option>';
  Object.keys(rec.expenseGroups).forEach(groupName => {
    const option = document.createElement('option');
    option.value = groupName; option.textContent = groupName;
    groupSelect.appendChild(option);
  });

  const expensesListDiv = $('expensesList');
  expensesListDiv.innerHTML = '';
  if (Object.keys(rec.expenseGroups).length === 0) {
    expensesListDiv.innerHTML = '<div class="muted">‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§ñ‡§∞‡•ç‡§ö ‡§ó‡§ü ‡§®‡§æ‡§π‡•Ä.</div>'; return;
  }

  for (const groupName in rec.expenseGroups) {
    const groupItems = rec.expenseGroups[groupName];
    const groupTotal = groupItems.reduce((sum, item) => sum + item.total, 0);
    const groupDiv = document.createElement('div');
    groupDiv.className = 'row-item';
    groupDiv.innerHTML = `<div><strong>${escapeHtml(groupName)}</strong> ‚Äî ‡§è‡§ï‡•Ç‡§£: ‚Çπ${groupTotal.toFixed(2)}</div>
      <div><button class="small" onclick="removeExpenseGroup('${escapeHtml(groupName)}')">Delete Group</button></div>`;
    expensesListDiv.appendChild(groupDiv);

    const nestedListDiv = document.createElement('div');
    nestedListDiv.className = 'nested-list';
    if (groupItems.length > 0) {
      groupItems.forEach((item, itemIndex) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'row-item';
        itemDiv.innerHTML = `<div>${escapeHtml(item.name)}: ‚Çπ${item.total.toFixed(2)}</div>
          <div><button class="small" onclick="removeExpenseItem('${escapeHtml(groupName)}', ${itemIndex})">Delete Item</button></div>`;
        nestedListDiv.appendChild(itemDiv);
      });
    } else {
      nestedListDiv.className += ' muted';
      nestedListDiv.textContent = '‡§Ø‡§æ ‡§ó‡§ü‡§æ‡§§ ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§ñ‡§∞‡•ç‡§ö ‡§®‡§æ‡§π‡•Ä.';
    }
    expensesListDiv.appendChild(nestedListDiv);
  }
}

function removeExpenseGroup(groupName){
  if(!confirm(`'${groupName}' ‡§π‡§æ ‡§ñ‡§∞‡•ç‡§ö ‡§ó‡§ü ‡§Ü‡§£‡§ø ‡§§‡•ç‡§Ø‡§æ‡§§‡•Ä‡§≤ ‡§∏‡§∞‡•ç‡§µ ‡§ñ‡§∞‡•ç‡§ö ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡•á ‡§ï‡§æ?`)) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  if(rec && rec.expenseGroups) delete rec.expenseGroups[groupName];
  localStorage.setItem('users', JSON.stringify(users));
  renderExpensesUI();
}

function removeExpenseItem(groupName, itemIndex){
  if(!confirm('‡§π‡§æ ‡§ñ‡§∞‡•ç‡§ö ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡§æ ‡§ï‡§æ?')) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  if(rec && rec.expenseGroups && rec.expenseGroups[groupName]) {
    rec.expenseGroups[groupName].splice(itemIndex, 1);
  }
  localStorage.setItem('users', JSON.stringify(users));
  renderExpensesUI();
}

function saveExpenses(){ alert('Expenses saved'); }

/* ========== Sign roles ========== */
function addSignRole(){
  if(!currentUser) return;
  const r = $('signRoleInput').value.trim();
  if(!r) return alert('‡§™‡§¶ ‡§≠‡§∞‡§æ');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  rec.signRoles.push(r);
  localStorage.setItem('users', JSON.stringify(users));
  $('signRoleInput').value='';
  renderSignRolesList();
}

function renderSignRolesList(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear] || { signRoles:[] };
  $('signRolesList').innerHTML = (rec.signRoles||[]).map((s,i)=>`<div class="row-item">${s} <button class="small" onclick="removeSignRole(${i})">Delete</button></div>`).join('') || '<div class="muted">No sign roles</div>';
}

function removeSignRole(i){
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const rec = users[currentUser].records[currentYear];
  if(rec && rec.signRoles) rec.signRoles.splice(i,1);
  localStorage.setItem('users', JSON.stringify(users));
  renderSignRolesList();
}

/* ========== Report rendering ========== */
function renderReport(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const u = users[currentUser];
  const rec = u.records[currentYear] || { group:{}, membersAmounts:{}, committee:[], donations:[], expenseGroups:{}, signRoles:[] };
  const groupNameToDisplay = u.groupName || '';
  const defaultFont = "'Baloo Bhai 2', 'Noto Sans Devanagari', sans-serif";
  const groupFont = (rec.group && rec.group.fontStyle) ? rec.group.fontStyle : defaultFont;

  // Header and Meta Info
  $('reportTitle').innerHTML = `<span class="report-group-name" style="font-family: ${groupFont};">${escapeHtml(groupNameToDisplay)}</span> ‚Äî ${currentYear}`;
  $('reportMoto').textContent = rec.group.moto || '';
  $('reportMoto').style.display = rec.group.moto ? 'block' : 'none';

  let metaHtml = '';
  if (rec.group.est) metaHtml += `<span class="report-meta-item">‡§∏‡•ç‡§•‡§æ‡§™‡§®‡§æ: ${rec.group.est}</span>`;
  if (rec.group.ganpatiDonorName) metaHtml += `<span class="report-meta-item">‡§ó‡§£‡§™‡§§‡•Ä ‡§Æ‡•Ç‡§∞‡•ç‡§§‡•Ä ‡§¶‡•á‡§®‡§ó‡•Ä‡§¶‡§æ‡§∞ : ${escapeHtml(rec.group.ganpatiDonorName)}</span>`;
  const reportMetaDiv = $('reportMeta');
  reportMetaDiv.innerHTML = metaHtml;
  reportMetaDiv.style.display = metaHtml.trim() ? 'block' : 'none';

  $('reportGroupLogo').src = rec.group.groupLogo || '';
  $('reportGanpatiLogo').src = rec.group.ganpatiLogo || '';

  // Committee Section
  const committeeTable = $('reportCommittee');
  const committeeHeader = committeeTable.previousElementSibling;
  const committeeData = rec.committee || [];
  if (committeeData.length > 0) {
    const tbodyC = committeeTable.querySelector('tbody');
    tbodyC.innerHTML = '';
    committeeData.forEach(c => { tbodyC.innerHTML += `<tr><td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.role)}</td></tr>`; });
    committeeTable.style.display = 'table';
    committeeHeader.style.display = 'block';
  } else {
    committeeTable.style.display = 'none';
    committeeHeader.style.display = 'none';
  }

  // Financial calculations
  let totalMemberAmount = Object.values(rec.membersAmounts || {}).reduce((sum, amt) => sum + (parseFloat(amt) || 0), 0);
  let totalDonationAmount = (rec.donations || []).reduce((sum, d) => sum + (d.amount || d.itemValue || 0), 0);
  let totalExpenseAmount = Object.values(rec.expenseGroups || {}).flat().reduce((sum, item) => sum + (item.total || 0), 0);
  const prevBalancePrincipal = rec.group.prevBalancePrincipal || 0;
  const prevBalanceInterest = rec.group.prevBalanceInterest || 0;
  const prevBalanceTotal = prevBalancePrincipal + prevBalanceInterest;
  const totalCollected = prevBalanceTotal + totalMemberAmount + totalDonationAmount;
  const finalBalance = totalCollected - totalExpenseAmount;
  
  // Financial Summary Table (Always visible)
  const tbodyMS = $('reportMembersSummary').querySelector('tbody');
  let summaryHtml = `<tr><td>‡§Æ‡§æ‡§ó‡•Ä‡§≤ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§ö‡•Ä ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï</td><td>‚Çπ ${prevBalancePrincipal.toFixed(2)}</td></tr>`;
  if (prevBalanceInterest > 0) {
      summaryHtml += `<tr><td>‡§§‡•ç‡§Ø‡§æ‡§µ‡§∞‡•Ä‡§≤ ‡§µ‡•ç‡§Ø‡§æ‡§ú</td><td>‚Çπ ${prevBalanceInterest.toFixed(2)}</td></tr>`;
  }
  summaryHtml += `
    <tr><td>‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§§‡•Ä‡§≤ ‡§ú‡§Æ‡§æ (‡§µ‡§∞‡•ç‡§ó‡§£‡•Ä)</td><td>‚Çπ ${totalMemberAmount.toFixed(2)}</td></tr>
    <tr><td>‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§∑‡§æ‡§§‡•Ä‡§≤ ‡§ú‡§Æ‡§æ (‡§¶‡•á‡§£‡§ó‡•Ä)</td><td>‚Çπ ${totalDonationAmount.toFixed(2)}</td></tr>
    <tr><td><strong>‡§è‡§ï‡•Ç‡§£ ‡§ú‡§Æ‡§æ</strong></td><td><strong>‚Çπ ${totalCollected.toFixed(2)}</strong></td></tr>
    <tr><td>‡§è‡§ï‡•Ç‡§£ ‡§ñ‡§∞‡•ç‡§ö</td><td>‚Çπ ${totalExpenseAmount.toFixed(2)}</td></tr>
    <tr><td><strong>‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï</strong></td><td><strong>‚Çπ ${finalBalance.toFixed(2)}</strong></td></tr>
  `;
  tbodyMS.innerHTML = summaryHtml;
  
  // Donations Section
  const donationsTable = $('reportDonations');
  const donationsHeader = donationsTable.previousElementSibling;
  const donationsData = rec.donations || [];
  if (donationsData.length > 0) {
      const tbodyD = donationsTable.querySelector('tbody');
      tbodyD.innerHTML = '';
      donationsData.forEach(d => {
          const description = d.type === 'cash' ? `‡§∞‡§ï‡•ç‡§ï‡§Æ` : escapeHtml(d.itemName);
          const value = d.amount || d.itemValue;
          tbodyD.innerHTML += `<tr><td>${escapeHtml(d.donorName)}</td><td>${description}</td><td>‚Çπ ${value.toFixed(2)}</td></tr>`;
      });
      donationsTable.style.display = 'table';
      donationsHeader.style.display = 'block';
  } else {
      donationsTable.style.display = 'none';
      donationsHeader.style.display = 'none';
  }

  // Expenses Section
  const expensesTable = $('reportExpenses');
  const expensesHeader = expensesTable.previousElementSibling;
  const expenseGroupNames = Object.keys(rec.expenseGroups || {});
  if (expenseGroupNames.length > 0) {
    const tbodyE = expensesTable.querySelector('tbody');
    tbodyE.innerHTML = '';
    expenseGroupNames.forEach(groupName => {
      const groupTotal = (rec.expenseGroups[groupName] || []).reduce((sum, item) => sum + item.total, 0);
      tbodyE.innerHTML += `<tr><td>${escapeHtml(groupName)}</td><td>‚Çπ ${groupTotal.toFixed(2)}</td></tr>`;
    });
    expensesTable.style.display = 'table';
    expensesHeader.style.display = 'block';
  } else {
    expensesTable.style.display = 'none';
    expensesHeader.style.display = 'none';
  }

  // Signatures Section
  const signaturesTable = $('reportSignatures');
  const signaturesHeader = signaturesTable.previousElementSibling;
  const signRoles = rec.signRoles || [];
  if (signRoles.length > 0) {
      const sigTableBody = signaturesTable.querySelector('tbody');
      sigTableBody.innerHTML = '';
      let sigHtml = '';
      for (let i = 0; i < signRoles.length; i += 2) {
          const role1 = signRoles[i];
          const role2 = signRoles[i+1];
          sigHtml += '<tr style="border: none;">';
          sigHtml += `<td style="border: none; padding: 25px 10px 5px; text-align: center; vertical-align: bottom;">
                          <div style="border-top: 1px solid #555; padding-top: 5px;">${escapeHtml(role1)}</div>
                      </td>`;
          if (role2) {
              sigHtml += `<td style="border: none; padding: 25px 10px 5px; text-align: center; vertical-align: bottom;">
                              <div style="border-top: 1px solid #555; padding-top: 5px;">${escapeHtml(role2)}</div>
                          </td>`;
          } else {
              sigHtml += '<td style="border: none;"></td>';
          }
          sigHtml += '</tr>';
      }
      sigTableBody.innerHTML = sigHtml;
      signaturesTable.style.display = 'table';
      signaturesHeader.style.display = 'block';
  } else {
      signaturesTable.style.display = 'none';
      signaturesHeader.style.display = 'none';
  }
  
  // Generated Date
  const now = new Date();
  const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
  const formattedDate = new Intl.DateTimeFormat('mr-IN', options).format(now);
  $('reportGeneratedDate').textContent = `‡§Ö‡§π‡§µ‡§æ‡§≤ ‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§µ‡•á‡§≥: ${formattedDate}`;
}


function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* ========== Dashboard list, load, delete, export/import ========== */
function renderYearsList(){
  if(!currentUser) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const recs = users[currentUser].records || {};
  const el = $('yearsList'); el.innerHTML = '';
  const years = Object.keys(recs).sort((a,b)=>b-a);
  if(years.length===0){ el.innerHTML = '<div class="muted">‡§ï‡•ã‡§£‡•Ä‡§π‡•Ä ‡§µ‡§∞‡•ç‡§∑‡§æ‡§ö‡•á ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§®‡§æ‡§π‡•Ä‡§§. ‚ûï Add New Year ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§æ.</div>'; return; }
  years.forEach(y=>{
    const r = recs[y];
    let expTotal = Object.values(r.expenseGroups || {}).flat().reduce((sum, item) => sum + (item.total || 0), 0);
    const memCount = Object.keys(r.membersAmounts||{}).length;
    const card = document.createElement('div'); card.className='dash-card';
    card.innerHTML = `<div><strong>${y}</strong></div><div class="muted">Members: ${memCount}</div><div class="muted">Expenses: ‚Çπ ${expTotal.toFixed(2)}</div>
      <div style="margin-top:8px">
        <button class="small" onclick="loadYear('${y}'); navOpen('info');">Load</button> <button class="small" onclick="loadYearAndShow('${y}')">View Report</button>
        <button class="small" onclick="deleteYear('${y}')">Delete</button>
      </div>`;
    el.appendChild(card);
  });
}

function loadYearAndShow(y){ loadYear(y); navOpen('report'); }
function deleteYear(y){
  if(!confirm('‡§µ‡§∞‡•ç‡§∑ '+y+' delete ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•á?')) return;
  users = JSON.parse(localStorage.getItem('users')||'{}');
  if(users[currentUser] && users[currentUser].records) delete users[currentUser].records[y];
  localStorage.setItem('users', JSON.stringify(users));
  renderYearsList();
}

/* ========== Utilities: Export/Import ========= */
function exportAll(){
  if(!currentUser) return alert('Login first');
  users = JSON.parse(localStorage.getItem('users')||'{}');
  const dataStr = JSON.stringify(users[currentUser], null, 2);
  const blob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `${currentUser}_data.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importPrompt(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = (e)=> {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try{
        const obj = JSON.parse(r.result);
        users = JSON.parse(localStorage.getItem('users')||'{}');
        if(!currentUser) { return alert('Please login first to import into your group'); }
        users[currentUser] = obj;
        localStorage.setItem('users', JSON.stringify(users));
        alert('Import successful');
        renderYearsList();
      } catch(err){ alert('Invalid JSON'); }
    };
    r.readAsText(f);
  };
  inp.click();
}

/* ========== Initialization: start on register view ========== */
(function init(){
  users = JSON.parse(localStorage.getItem('users')||'{}');
  showSection('secRegister');
  populateYearSelect();
})();
</script>
</body>
</html>
